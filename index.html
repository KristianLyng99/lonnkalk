<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monthly Earnings Calculator with Calendar Integration</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    body {
      background-color: #f8f9fa;
      padding: 20px;
      color: #333;
    }
    
    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      width: 100%;
      padding: 24px;
      margin: 0 auto;
    }
    
    h1 {
      color: #0e766e;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    
    h2 {
      color: #0e766e;
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px 0;
    }
    
    .total-section {
      background-color: #e6fffa;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 24px;
    }
    
    .total-amount {
      font-size: 36px;
      font-weight: bold;
      color: #0e766e;
      margin-bottom: 5px;
    }
    
    .info-text {
      color: #718096;
      font-size: 14px;
      margin-bottom: 5px;
    }
    
    .tab-container {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 500;
      border-bottom: 2px solid transparent;
    }
    
    .tab.active {
      color: #0e766e;
      border-bottom: 2px solid #0e766e;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .shift-form {
      background-color: #f7fafc;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .form-title {
      font-weight: 600;
      margin-bottom: 12px;
      color: #0e766e;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .form-group {
      flex: 1;
      min-width: 120px;
    }
    
    .form-group label {
      display: block;
      font-size: 13px;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .btn {
      display: inline-block;
      background-color: #0e766e;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .btn:hover {
      background-color: #0c6259;
    }
    
    .btn-red {
      background-color: #e53e3e;
    }
    
    .btn-red:hover {
      background-color: #c53030;
    }
    
    .btn-full {
      width: 100%;
    }
    
    .shifts-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }
    
    .shifts-table th,
    .shifts-table td {
      border: 1px solid #e2e8f0;
      padding: 10px;
      text-align: left;
    }
    
    .shifts-table th {
      background-color: #f7fafc;
      font-weight: 600;
    }
    
    .shifts-table tr:nth-child(even) {
      background-color: #f7fafc;
    }
    
    .text-center {
      text-align: center;
    }
    
    .no-shifts {
      text-align: center;
      padding: 20px;
      color: #718096;
      font-style: italic;
    }
    
    .action-column {
      width: 80px;
      text-align: center;
    }
    
    .clear-all {
      color: #e53e3e;
      text-decoration: underline;
      background: none;
      border: none;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .clear-all:hover {
      color: #c53030;
    }
    
    .break-container {
      display: flex;
      align-items: center;
    }
    
    .break-checkbox {
      margin-right: 10px;
      width: auto;
    }
    
    .import-preview {
      margin-top: 16px;
      background-color: #f0f9ff;
      border-radius: 8px;
      padding: 16px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
    }
    
    .preview-item {
      padding: 8px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
    }
    
    .preview-item:last-child {
      border-bottom: none;
    }
    
    .preview-checkbox {
      margin-right: 10px;
    }
    
    .success-message {
      background-color: #d1fae5;
      color: #065f46;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .error-message {
      background-color: #fee2e2;
      color: #b91c1c;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .step {
      margin-bottom: 16px;
    }
    
    .step-number {
      display: inline-block;
      width: 24px;
      height: 24px;
      background-color: #0e766e;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      margin-right: 8px;
    }
    
    .instruction {
      margin-left: 32px;
      margin-bottom: 8px;
    }
    
    .code {
      font-family: monospace;
      background-color: #f7fafc;
      padding: 2px 4px;
      border-radius: 2px;
    }
    
    .file-input-container {
      margin-top: 16px;
    }
    
    .file-input-label {
      display: block;
      background-color: #f7fafc;
      border: 1px dashed #d1d5db;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 16px;
    }
    
    .file-input-label:hover {
      background-color: #edf2f7;
    }
    
    .file-input {
      display: none;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(0, 0, 0, 0.1);
      border-top-color: #0e766e;
      border-radius: 50%;
      animation: spin 1s infinite linear;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .url-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 10px;
    }
    
    .or-divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: #718096;
    }
    
    .or-divider::before,
    .or-divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .or-divider span {
      padding: 0 10px;
    }
    
    .save-link-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }
    
    .save-link-container input[type="checkbox"] {
      margin-right: 10px;
    }
    
    .saved-links {
      margin-top: 16px;
      max-height: 150px;
      overflow-y: auto;
      background-color: #f7fafc;
      border-radius: 4px;
      padding: 10px;
    }
    
    .saved-link-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .saved-link-item:last-child {
      border-bottom: none;
    }
    
    .link-actions {
      display: flex;
      gap: 8px;
    }
    
    .link-actions button {
      padding: 2px 6px;
      font-size: 12px;
    }
    
    .edit-link-form {
      margin-top: 16px;
      padding: 10px;
      background-color: #f7fafc;
      border-radius: 4px;
    }
    
    .edit-link-form .form-group {
      margin-bottom: 10px;
    }
    
    @media (max-width: 600px) {
      .form-group {
        min-width: 100%;
      }
      
      .tab {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Monthly Earnings Calculator</h1>
    
    <div class="total-section">
      <div class="info-text">Total monthly earnings:</div>
      <div class="total-amount" id="totalAmount">0.00 kr</div>
      <div class="info-text">Base hourly rate: 284.49 kr</div>
      <div class="info-text" id="totalHours">Total hours: 0</div>
    </div>
    
    <div class="tab-container">
      <div class="tab active" data-tab="manual">Manual Entry</div>
      <div class="tab" data-tab="calendar">Import Calendar</div>
    </div>
    
    <div class="tab-content active" id="manual-tab">
      <div class="shift-form">
        <div class="form-title">Add Work Shift</div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="shiftDate">Date:</label>
            <input type="date" id="shiftDate" required>
          </div>
          
          <div class="form-group">
            <label for="shiftType">Day Type:</label>
            <select id="shiftType">
              <option value="auto">Auto-detect from date</option>
              <option value="weekday">Mon-Thu</option>
              <option value="friday">Friday</option>
              <option value="saturday">Saturday</option>
              <option value="sunday">Sunday</option>
              <option value="holiday">Holiday</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="startTime">Start Time:</label>
            <input type="time" id="startTime" value="09:00" required>
          </div>
          
          <div class="form-group">
            <label for="endTime">End Time:</label>
            <input type="time" id="endTime" value="17:00" required>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="breakCheck">Include 30-min meal break?</label>
            <div class="break-container">
              <input type="checkbox" id="breakCheck" class="break-checkbox">
              <input type="time" id="breakTime" value="12:00">
            </div>
          </div>
        </div>
        
        <button class="btn btn-full" id="addShiftBtn">Add Shift</button>
      </div>
    </div>
    
    <div class="tab-content" id="calendar-tab">
      <div class="shift-form">
        <div class="form-title">Import Shifts from Calendar</div>
        
        <div id="savedLinksSection" style="display: none;">
          <h2>Your Saved Calendar Links</h2>
          <div class="saved-links" id="savedLinksContainer">
            <!-- Saved links will be displayed here -->
          </div>
        </div>
        
        <div class="step">
          <span class="step-number">1</span>
          <span>Enter your calendar URL:</span>
        </div>
        
        <input type="url" id="calendarUrl" class="url-input" placeholder="https://api.example.com/calendar/data/ics?calendarId=YOUR_ID">
        
        <div class="save-link-container">
          <input type="checkbox" id="saveLink" checked>
          <label for="saveLink">Save this link for future use</label>
        </div>
        
        <div class="form-group" id="linkNameContainer" style="margin-top: 10px;">
          <label for="linkName">Give this calendar link a name:</label>
          <input type="text" id="linkName" placeholder="Work Schedule" required>
        </div>
        
        <button class="btn btn-full" id="fetchCalendarBtn" style="margin-top: 16px;">Fetch Calendar</button>
        
        <div class="or-divider">
          <span>OR</span>
        </div>
        
        <div class="step">
          <span class="step-number">2</span>
          <span>Upload a calendar file (.ics):</span>
        </div>
        
        <div class="file-input-container">
          <label for="calendarFile" class="file-input-label">
            <span>Click to select a .ics file</span>
            <input type="file" id="calendarFile" class="file-input" accept=".ics">
          </label>
        </div>
        
        <div class="or-divider">
          <span>OR</span>
        </div>
        
        <div class="step">
          <span class="step-number">3</span>
          <span>Upload a screenshot of your schedule:</span>
        </div>
        
        <div class="file-input-container">
          <label for="scheduleImage" class="file-input-label">
            <span>Click to select an image of your schedule</span>
            <input type="file" id="scheduleImage" class="file-input" accept="image/*">
          </label>
        </div>
        
        <div id="imagePreview" style="display:none; margin-top:16px; max-width:100%; text-align:center;">
          <img id="previewImg" style="max-width:100%; max-height:300px; border:1px solid #d1d5db; border-radius:4px;">
        </div>
        
        <div id="imageProcessingMessage" style="display:none; margin-top:16px;"></div>
        
        <div id="extractedShifts" class="import-preview" style="display:none;"></div>
        
        <button class="btn btn-full" id="addExtractedShiftsBtn" style="display:none; margin-top:16px;">Add Extracted Shifts</button>
        
        <div class="step">
          <span class="step-number">?</span>
          <span>How to get your calendar link:</span>
        </div>
        
        <div class="instruction">
          1. Log in to your work scheduling system
        </div>
        <div class="instruction">
          2. Look for "Calendar Export", "Subscribe", or "iCal" options
        </div>
        <div class="instruction">
          3. Copy the URL that ends with .ics or contains "calendar/data/ics"
        </div>
        <div class="instruction">
          4. Paste it in the field above
        </div>
        
        <div id="calendarMessage" style="display:none; margin-top:16px;"></div>
        
        <div id="calendarPreview" class="import-preview" style="display:none;"></div>
        
        <button class="btn btn-full" id="addCalendarShiftsBtn" style="display:none; margin-top:16px;">Add Selected Shifts</button>
      </div>
    </div>
    
    <h2>Shifts This Month</h2>
    <div id="shiftsTableContainer">
      <div class="no-shifts">No shifts added yet. Add shifts using one of the methods above.</div>
    </div>
    
    <div class="text-center">
      <button class="clear-all" id="clearAllBtn">Clear All Shifts</button>
    </div>
  </div>

  <script>
    (function() {
      // Constants
      const BASE_RATE = 284.49;
      
      // DOM Elements - Tabs
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      // DOM Elements - Manual Entry
      const totalAmountEl = document.getElementById('totalAmount');
      const totalHoursEl = document.getElementById('totalHours');
      const dateInput = document.getElementById('shiftDate');
      const typeSelect = document.getElementById('shiftType');
      const startTimeInput = document.getElementById('startTime');
      const endTimeInput = document.getElementById('endTime');
      const breakCheckbox = document.getElementById('breakCheck');
      const breakTimeInput = document.getElementById('breakTime');
      const addShiftBtn = document.getElementById('addShiftBtn');
      
      // DOM Elements - Calendar Import
      const calendarUrlInput = document.getElementById('calendarUrl');
      const saveCalendarLink = document.getElementById('saveLink');
      const linkNameInput = document.getElementById('linkName');
      const fetchCalendarBtn = document.getElementById('fetchCalendarBtn');
      const calendarFileInput = document.getElementById('calendarFile');
      const calendarMessage = document.getElementById('calendarMessage');
      const calendarPreview = document.getElementById('calendarPreview');
      const addCalendarShiftsBtn = document.getElementById('addCalendarShiftsBtn');
      const savedLinksSection = document.getElementById('savedLinksSection');
      const savedLinksContainer = document.getElementById('savedLinksContainer');
      
      // DOM Elements - Other
      const clearAllBtn = document.getElementById('clearAllBtn');
      const tableContainer = document.getElementById('shiftsTableContainer');
      
      // Set today's date as default
      dateInput.value = new Date().toISOString().split('T')[0];
      
      // Store shifts and parsed shifts
      let shifts = [];
      let parsedCalendarShifts = [];
      let savedLinks = [];
      
      // Load saved calendar links
      loadSavedLinks();
      
      // Tab switching
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');
        });
      });
      
      // Load shifts from localStorage if available
      if (localStorage.getItem('monthlyShifts')) {
        try {
          const savedShifts = JSON.parse(localStorage.getItem('monthlyShifts'));
          if (Array.isArray(savedShifts)) {
            shifts = savedShifts.map(shift => ({
              ...shift,
              date: new Date(shift.date)
            }));
            updateShiftsTable();
            updateTotals();
          }
        } catch (e) {
          console.error("Error loading saved shifts:", e);
        }
      }
      
      // Compensation rates based on day type and time
      const compensationRates = {
        'weekday': [
          { range: '06:00-08:00', rate: 1.25 },
          { range: '08:00-16:00', rate: 1.00 },
          { range: '16:00-18:00', rate: 1.25 },
          { range: '18:00-21:00', rate: 1.30 },
          { range: '21:00-06:00', rate: 2.00 },
          { range: 'default', rate: 1.00 }
        ],
        'friday': [
          { range: '06:00-08:00', rate: 1.25 },
          { range: '08:00-16:00', rate: 1.00 },
          { range: '16:00-21:00', rate: 1.50 },
          { range: '21:00-06:00', rate: 2.00 },
          { range: 'default', rate: 1.00 }
        ],
        'saturday': [
          { range: '00:00-06:00', rate: 2.00 },
          { range: '06:00-15:30', rate: 2.00 },
          { range: '15:30-24:00', rate: 2.20 },
          { range: 'default', rate: 2.00 }
        ],
        'sunday': [
          { range: '00:00-24:00', rate: 2.20 },
          { range: 'default', rate: 2.20 }
        ],
        'holiday': [
          { range: '00:00-24:00', rate: 2.50 },
          { range: 'default', rate: 2.50 }
        ]
      };
      
      // Norwegian holidays (simplified)
      const holidays = [
        { month: 0, day: 1 },    // Jan 1 - New Year
        { month: 4, day: 1 },    // May 1 - Labor Day
        { month: 4, day: 17 },   // May 17 - Constitution Day
        { month: 11, day: 25 },  // Dec 25 - Christmas
        { month: 11, day: 26 }   // Dec 26 - Boxing Day
      ];
      
      // Helper: Check if date is a holiday
      function isHoliday(date) {
        const month = date.getMonth();
        const day = date.getDate();
        
        return holidays.some(h => h.month === month && h.day === day);
      }
      
      // Helper: Determine day type from date
      function getDayTypeFromDate(date) {
        if (isHoliday(date)) return 'holiday';
        
        const day = date.getDay();
        if (day === 0) return 'sunday';
        if (day === 6) return 'saturday';
        if (day === 5) return 'friday';
        return 'weekday';
      }
      
      // Helper: Convert time string to minutes
      function timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
      }
      
      // Helper: Check if time is in range
      function isTimeInRange(time, start, end) {
        const timeMin = timeToMinutes(time);
        const startMin = timeToMinutes(start);
        let endMin = timeToMinutes(end);
        
        // Handle overnight ranges
        if (endMin < startMin) {
          endMin += 24 * 60;
          
          const timeHours = parseInt(time.split(':')[0]);
          let adjustedTimeMin = timeMin;
          
          if (timeHours < 12 && startMin > 12 * 60) {
            adjustedTimeMin += 24 * 60;
          }
          
          return adjustedTimeMin >= startMin || timeMin <= endMin;
        }
        
        return timeMin >= startMin && timeMin <= endMin;
      }
      
      // Format date for display
      function formatDate(date) {
        return date.toLocaleDateString(undefined, {
          weekday: 'short',
          month: 'short',
          day: 'numeric'
        });
      }
      
      // Load saved calendar links from localStorage
      function loadSavedLinks() {
        try {
          const savedLinksStr = localStorage.getItem('savedCalendarLinks');
          if (savedLinksStr) {
            savedLinks = JSON.parse(savedLinksStr);
            updateSavedLinksUI();
          }
        } catch (e) {
          console.error("Error loading saved links:", e);
          savedLinks = [];
        }
      }
      
      // Save calendar links to localStorage
      function saveSavedLinks() {
        localStorage.setItem('savedCalendarLinks', JSON.stringify(savedLinks));
        updateSavedLinksUI();
      }
      
      // Update saved links UI
      function updateSavedLinksUI() {
        if (savedLinks.length === 0) {
          savedLinksSection.style.display = 'none';
          return;
        }
        
        savedLinksSection.style.display = 'block';
        savedLinksContainer.innerHTML = '';
        
        savedLinks.forEach((link, index) => {
          const linkItem = document.createElement('div');
          linkItem.className = 'saved-link-item';
          
          const linkName = document.createElement('div');
          linkName.textContent = link.name;
          
          const linkActions = document.createElement('div');
          linkActions.className = 'link-actions';
          
          const useBtn = document.createElement('button');
          useBtn.className = 'btn';
          useBtn.textContent = 'Use';
          useBtn.addEventListener('click', () => {
            calendarUrlInput.value = link.url;
            linkNameInput.value = link.name;
            showCalendarMessage(`Selected "${link.name}" calendar`, true);
          });
          
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-red';
          deleteBtn.textContent = 'Delete';
          deleteBtn.addEventListener('click', () => {
            if (confirm(`Are you sure you want to delete the "${link.name}" calendar link?`)) {
              savedLinks.splice(index, 1);
              saveSavedLinks();
            }
          });
          
          linkActions.appendChild(useBtn);
          linkActions.appendChild(deleteBtn);
          
          linkItem.appendChild(linkName);
          linkItem.appendChild(linkActions);
          savedLinksContainer.appendChild(linkItem);
        });
      }
      
      // Add a new saved link
      function addSavedLink(name, url) {
        // Check if this URL already exists
        const exists = savedLinks.some(link => link.url === url);
        
        if (!exists) {
          savedLinks.push({ name, url });
          saveSavedLinks();
          return true;
        }
        
        return false;
      }
      
      // Calculate earnings for a shift
      function calculateShiftEarnings(date, dayType, startTime, endTime, includeBreak, breakTime) {
        // Calculate duration
        let startMinutes = timeToMinutes(startTime);
        let endMinutes = timeToMinutes(endTime);
        
        // Handle overnight shifts
        if (endMinutes < startMinutes) {
          endMinutes += 24 * 60;
        }
        
        // Get rates for this day type
        const rates = compensationRates[dayType];
        
        // Handle meal break
        if (includeBreak && breakTime) {
          // Get break time in minutes
          let breakStartMinutes = timeToMinutes(breakTime);
          
          // For overnight shifts, adjust break time if needed
          if (startMinutes > endMinutes && breakStartMinutes < startMinutes) {
            breakStartMinutes += 24 * 60;
          }
          
          // Make sure break is within shift hours
          if (breakStartMinutes >= startMinutes && breakStartMinutes + 30 <= endMinutes) {
            // Break is within shift time
            // We'll calculate earnings in two parts: before break and after break
            
            const breakEndMinutes = breakStartMinutes + 30; // 30 minute break
            
            // Calculate first part (start to break)
            const firstPartEarnings = calculatePartialShiftEarnings(
              dayType, 
              rates,
              startMinutes, 
              breakStartMinutes
            );
            
            // Calculate second part (after break to end)
            const secondPartEarnings = calculatePartialShiftEarnings(
              dayType,
              rates,
              breakEndMinutes,
              endMinutes
            );
            
            // Combine results
            return {
              duration: (breakStartMinutes - startMinutes + endMinutes - breakEndMinutes) / 60,
              earnings: firstPartEarnings.earnings + secondPartEarnings.earnings,
              segments: [...first
